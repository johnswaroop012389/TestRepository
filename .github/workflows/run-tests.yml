name: Run Java Tests

on:
  workflow_dispatch:
    inputs:
      run_target:
        description: 'Which test to run (both, class1, class2)'
        required: true
        default: 'both'

jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Run Maven Tests
        id: run-tests
        continue-on-error: true
        run: |
          echo "running tests..."
          mvn test -Dsurefire.suiteXmlFiles=testng.xml -DrunTarget=${{ github.event.inputs.run_target }}
          echo "status=$?" >> $GITHUB_OUTPUT

      - name: Extract summary from TestNG report
        run: |
          echo "üìÑ Extracting summary from emailable-report.html..."
          REPORT=$(find . -name emailable-report.html | head -n 1)
          if [ -f "$REPORT" ]; then
            SUMMARY_LINE=$(grep -A1 "Total" "$REPORT" | tail -1 | sed -e 's/<[^>]*>/ /g' -e 's/^[ \t]*//;s/[ \t]*$//')
            FAILED=$(echo "$SUMMARY_LINE" | awk '{print $4}')
            if [ "$FAILED" = "0" ] || [ -z "$FAILED" ]; then
              echo "‚úÖ Summary Report - Passed" > summary.txt
            else
              echo "‚úÖ Summary Report - Failed" > summary.txt
            fi
          else
            echo "‚ùå emailable-report.html not found!" > summary.txt
          fi

      - name: Print results.txt to GitHub Actions UI
        run: |
          cat results.txt
          echo "üìÅ Files in directory:"
          ls -la

      - name: Upload TestNG Report
        uses: actions/upload-artifact@v4
        with:
          name: testng-report
          path: |
            test-output/
            results.txt
            summary.txt

      - name: Fail job if tests failed
        if: steps.run-tests.outputs.status != '0'
        run: |
          echo "‚ùå Tests failed. Marking job as failed."
          exit 1
